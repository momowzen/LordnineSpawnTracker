#!/bin/sh
# prepare-commit-msg hook: auto-commit with generated message from index.html title or first h1

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"
SHA1="$3"

# Only run for non-merge commits
if [ "$COMMIT_SOURCE" = "merge" ]; then
  exit 0
fi

# Only proceed if index.html is staged
if git diff --cached --name-only | grep -q "index.html"; then
  # Extract staged index.html content
  tmpfile=$(mktemp)
  git show :index.html > "$tmpfile" 2>/dev/null || git show HEAD:index.html > "$tmpfile" 2>/dev/null

  # Try <title> first, then <h1>
  title=$(sed -n 's/.*<title>\(.*\)<\/title>.*/\1/p' "$tmpfile" | head -n1 | sed 's/^[ \t]*//;s/[ \t]*$//')
  if [ -z "$title" ]; then
    title=$(sed -n 's/.*<h1[^>]*>\(.*\)<\/h1>.*/\1/p' "$tmpfile" | head -n1 | sed 's/^[ \t]*//;s/[ \t]*$//')
  fi
  rm "$tmpfile"

  if [ -n "$title" ]; then
    gen_title="feat(index.html): ${title}"
    gen_title=$(echo "$gen_title" | cut -c1-72)

    # Auto-commit directly
    echo "[auto-commit-hook] Generated message: $gen_title"
    git commit -m "$gen_title" --no-verify

    # Cancel the original commit process (since we've committed already)
    exit 1
  fi
fi

exit 0
