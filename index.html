<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lord Nine ‚Äî Compact Tracker</title>

<style>
:root{
  --bg:#07101a;
  --muted:#9aa6b2;
  --accent:#00f0ff;
  --accent-2:#7dd3fc;
  --glass:rgba(255,255,255,0.03);
  --radius:10px;
  --shadow:0 6px 20px rgba(0,240,255,0.04);
  --glass-border: rgba(0,240,255,0.08);
  --text:#dff7ff;
}

/* Reset & base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{
  height:100%;
  overflow:hidden; /* whole page unscrollable */
  font-family:Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
}

/* Layout */
.container{
  display:flex;
  flex-direction:column;
  height:100%;
  padding:12px;
  max-width:1200px;
  margin:0 auto;
  gap:12px;
}

/* Header */
header.app-header{
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
  border:1px solid var(--glass-border);
  padding:8px 12px;
  border-radius:8px;
  box-shadow:var(--shadow);
  backdrop-filter: blur(6px);
}
.app-title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--accent)}
.logo{
  width:32px;height:32px;
  border-radius:8px;
  background:linear-gradient(135deg, rgba(0,240,255,0.08), rgba(125,211,252,0.04));
  display:grid;place-items:center;
  color:var(--accent-2);font-weight:900;font-family:"Consolas",monospace;font-size:12px;
}
.header-controls{display:flex;gap:8px;align-items:center}
.search{
  width:200px;background:transparent;border:1px solid var(--glass-border);
  padding:6px 10px;border-radius:8px;color:var(--text);font-size:13px;
}
.settings{
  width:32px;height:32px;border-radius:8px;border:none;background:transparent;cursor:pointer;
  display:grid;place-items:center;transition:transform .12s ease;
}
.settings:hover{transform:translateY(-2px)}

/* Main */
.main{
  flex:1 1 auto;
  display:grid;
  grid-template-columns:1fr 360px;
  gap:12px;
  min-height:0;
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.05));
  border:1px solid var(--glass-border);
  border-radius:var(--radius);
  padding:10px;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  min-height:0;
}

/* ensure parent containers can shrink (needed for children to scroll) */
.main, .container, .card { min-height: 0; }

/* layout for right column so its cards can flex vertically */
.right-column { display: flex; flex-direction: column; gap: 10px; min-height: 0; }

/* make only the boss list & timers fill available card space and scroll */
#bossList,
#timers {
  flex: 1 1 auto;          /* grow/shrink inside the .card column */
  overflow-y: auto;        /* vertical scrolling only */
  -webkit-overflow-scrolling: touch;
  min-height: 0;
}

/* Boss list */
#bossList {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  overflow-y: auto;        /* ‚úÖ allows vertical scrolling */
  overflow-x: hidden;      /* ‚úÖ hides sideways scaling */
  padding: 6px 4px;
  max-height: 100%;        /* keeps it flexible within panel */
  scroll-behavior: smooth;
}


.boss {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 95%; /* üîπ slightly narrower to prevent overflow */
  padding: 8px 10px;
  border-radius: 8px;
  background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));
  border: 1px solid rgba(255,255,255,0.02);
  font-size: 13px;
  transition: transform 0.2s ease, box-shadow 0.25s ease;
  box-sizing: border-box;
}

.boss .meta{display:flex;flex-direction:column;gap:2px}
.boss .name{font-weight:700}
.boss .sub{font-size:11px;color:var(--muted)}

/* --- Action buttons (Mark Dead, Set Timer, Clear) --- */
.kbtn {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid rgba(0,240,255,0.14);
  background: var(--glass);
  color: var(--accent);
  cursor: pointer;
  font-size: 12px;
  font-weight: 700;
  transition: all 0.2s ease;
}

.kbtn:hover {
  background: linear-gradient(90deg, rgba(0,240,255,0.15), rgba(125,211,252,0.15));
  border-color: rgba(0,240,255,0.4);
  color: #fff;
  box-shadow: 0 0 8px rgba(0,240,255,0.4);
  transform: translateY(-1px);
}

.kbtn:active {
  transform: translateY(0);
  box-shadow: 0 0 4px rgba(0,240,255,0.2);
}


/* --- Refreshed Next Boss panel (compact, gamer style) --- */
#nextBoss {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 16px 12px; /* slightly tighter padding */
  border-radius: 10px;
  border: 1px solid rgba(0, 240, 255, 0.15);
  background: linear-gradient(180deg, rgba(0,240,255,0.05), rgba(0,0,0,0.25));
  box-shadow: 0 0 12px rgba(0,240,255,0.08);
}

#nextBoss .boss-name {
  font-size: 20px;
  font-weight: 800;
  color: var(--accent);
  text-shadow: 0 0 8px rgba(0,240,255,0.4);
  margin-bottom: 1px; /* üîπ reduced spacing between name & time */
}

#nextBoss .time-remaining {
  margin-top: 0; /* üîπ remove extra gap */
  font-size: 12px;
  color: var(--accent-2);
  font-weight: 700;
  text-shadow: 0 0 6px rgba(125,211,252,0.5);
}

/* Active Timers panel */
#timers {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  overflow-y: auto;       /* ‚úÖ scrollable vertically */
  overflow-x: hidden;     /* ‚úÖ prevent horizontal overflow from scale */
  padding: 6px 4px;
  max-height: 100%;       /* keep flexible within its container */
  scroll-behavior: smooth;
}
/* Timer card style */
.timer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 95%;             /* üîπ narrower width to contain hover */
  padding: 8px 10px;
  border-radius: 8px;
  background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));
  border: 1px solid rgba(255,255,255,0.02);
  font-size: 13px;
  transition: transform 0.2s ease, box-shadow 0.25s ease;
  box-sizing: border-box;
}
.timer.ready{border-color:rgba(0,240,255,0.18)}

/* --- Custom neon scrollbar for panels --- */
#bossList::-webkit-scrollbar,
#timers::-webkit-scrollbar {
  width: 8px;
}

#bossList::-webkit-scrollbar-track,
#timers::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
}

#bossList::-webkit-scrollbar-thumb,
#timers::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--accent), var(--accent-2));
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(0,240,255,0.4);
}

#bossList::-webkit-scrollbar-thumb:hover,
#timers::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, var(--accent-2), var(--accent));
}

/* Firefox support */
#bossList,
#timers {
  scrollbar-width: thin;
  scrollbar-color: var(--accent) rgba(255,255,255,0.03);
}


/* --- Responsive mobile layout --- */
@media (max-width: 720px) {
  .main {
    display: flex;
    flex-direction: column;
  }

  /* Order: 1Ô∏è‚É£ Next Boss 2Ô∏è‚É£ Active Timers 3Ô∏è‚É£ Boss List */
  #nextBoss {
    order: 1;
    flex: 0 0 auto;
  }

  #timersPanel {
    order: 2;
    flex: 1 1 auto;
    min-height: 0;
  }

  #bossListPanel {
    order: 3;
    flex: 1 1 auto;
    min-height: 0;
  }

  #bossList,
  #timers {
    overflow-y: auto;
  }
}


/* --- Settings dropdown menu --- */
.settings-menu {
  position: absolute;
  top: 48px;
  right: 10px;
  background: linear-gradient(180deg, rgba(0,240,255,0.25), rgba(0,0,0,0.92));
  border: 1px solid rgba(0,240,255,0.25);
  border-radius: 10px;
  box-shadow: 0 0 12px rgba(0,240,255,0.15);
  display: flex;
  flex-direction: column;
  min-width: 160px;
  overflow: hidden;
  z-index: 1000;
  backdrop-filter: blur(8px);
}

.menu-item {
  background: transparent;
  color: var(--accent);
  font-size: 13px;
  font-weight: 600;
  border: none;
  text-align: left;
  padding: 10px 14px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.menu-item:hover {
  background: rgba(0,240,255,0.1);
  color: #fff;
  text-shadow: 0 0 8px rgba(0,240,255,0.6);
}

.header-controls {
  position: relative;
  display: flex;
  align-items: center;       /* ‚úÖ vertical centering */
  justify-content: space-between;
  height: 60px;              /* or match your header height */
  padding: 0 10px;
}

/* Boss name when marked dead (active timer started) */
.boss.dead .name {
  color: rgba(255, 60, 60, 0.9);
  text-shadow: 0 0 8px rgba(255, 60, 60, 0.5);
}

/* === Neon loading overlay === */
#loadingOverlay {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at center, rgba(0, 10, 20, 0.95) 0%, rgba(0, 0, 0, 0.98) 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(8px);
}

.loader-text {
  color: var(--accent);
  font-size: 1.3rem;
  font-weight: 700;
  letter-spacing: 2px;
  text-shadow: 0 0 10px var(--accent);
  animation: pulseText 1.5s infinite;
}

/* optional glowing ring animation */
#loadingOverlay::before {
  content: "";
  width: 80px;
  height: 80px;
  border: 3px solid rgba(0, 240, 255, 0.2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1.4s linear infinite;
  margin-bottom: 18px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes pulseText {
  0%, 100% { opacity: 0.7; text-shadow: 0 0 8px rgba(0, 240, 255, 0.6); }
  50% { opacity: 1; text-shadow: 0 0 14px rgba(0, 240, 255, 1); }
}

/* --- Search bar container --- */
.search-wrapper {
  position: relative;
  display: inline-flex;
  align-items: center;
}

.search {
  padding-right: 28px; /* space for the X icon */
}

/* --- X clear icon --- */
.clear-icon {
  position: absolute;
  right: 8px;
  font-size: 18px;
  color: rgba(0, 240, 255, 0.4);
  cursor: pointer;
  user-select: none;
  display: none;
  transition: color 0.2s ease, opacity 0.2s ease;
}

/* Show on hover or when input has text */
.search-wrapper:hover .clear-icon,
.search-wrapper.has-text .clear-icon {
  display: block;
  opacity: 0.8;
}

.clear-icon:hover {
  color: var(--accent);
  opacity: 1;
  text-shadow: 0 0 6px var(--accent);
}

.logo {
  display: flex;
  align-items: center;       /* vertical centering */
  justify-content: center;   /* optional: center horizontally within its flex box */
  height: 100%;              /* make logo container fill header height */
}


.logo-img {
  height: 40px;             /* smaller ‚Äî fits typical header height */
  max-height: 100%;
  width: auto;
  object-fit: contain;
  filter: drop-shadow(0 0 6px rgba(0,240,255,0.4));
  transition: transform 0.2s ease, filter 0.2s ease;
  display: block;
}

.logo-img:hover {
  transform: scale(1.05);
  filter: drop-shadow(0 0 10px rgba(0,240,255,0.7));
}

/* === Hover enlarge effect for panels + search bar === */
#nextBoss,
#timersPanel,
#bossListPanel,
.search-wrapper {
  transition: transform 0.2s ease, box-shadow 0.3s ease;
}

/* Hover animation */
#nextBoss:hover,
#timersPanel:hover,
#bossListPanel:hover,
.search-wrapper:hover {
  transform: scale(1.02); /* üîπ slight enlarge */
  box-shadow: 0 0 20px rgba(0, 240, 255, 0.25);
  z-index: 5;
}

/* === Dead boss indicator === */
.boss.dead .name::after {
  content: " üíÄ"; /* you can replace with any emoji or icon character */
  font-size: 16px;
  margin-left: 6px;
  opacity: 0.85;
  text-shadow: 0 0 6px rgba(255, 60, 60, 0.6);
}

/* === Hover enlarge effect for individual boss & timer cards === */
.boss,
.timer {
  transition: transform 0.2s ease, box-shadow 0.25s ease;
  border-radius: 10px;
}

.boss:hover,
.timer:hover {
  transform: scale(1.02);
  box-shadow: 0 0 14px rgba(0, 240, 255, 0.25);
  z-index: 2;
}


</style>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="app-title">
        <div class="logo">
		  <img src="https://i.ibb.co/JF0mpZW9/Lucid-Origin-A-logo-for-a-Discord-server-with-the-guild-name-D-3.jpg" alt="DFCK Logo" class="logo-img" />
		</div>
        <div>
          <div style="font-size:13px">LORDNINE FIELD BOSS SPAWN TIME TRACKER</div>
          <div style="font-size:11px;color:var(--muted)">Creadted by: [DFck]Tadatokichi</div>
        </div>
      </div>
      <div class="header-controls">
        <div class="search-wrapper">
		  <input id="bossSearch" class="search" placeholder="Search boss..." />
		  <span id="clearSearch" class="clear-icon">&times;</span>
		</div>

        <button id="settingsBtn" class="settings" aria-label="Settings">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent)">
            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9.5 19a1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 0 1 4.8 16.5l.06-.06A1.65 1.65 0 0 0 5.18 14.6 1.65 1.65 0 0 0 4 13V12a2 2 0 0 1 2-2h.09c.39-.62 1-1.16 1.72-1.54a1.65 1.65 0 0 0 .33-1.82L9.2 4.8a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 14.6 4.18 1.65 1.65 0 0 0 16 4v.09A2 2 0 0 1 18 6h.09c.39.62 1 1.16 1.72 1.54A1.65 1.65 0 0 0 20.82 9.4z"/>
          </svg>
        </button>
		 <div id="settingsMenu" class="settings-menu" style="display:none;">
		  <button id="exportBtn" class="menu-item">üì§ Export JSON</button>
		  <button id="importBtn" class="menu-item">üì• Import JSON</button>
		  <button id="resetBtn" class="menu-item">üóëÔ∏è Reset All</button>
		 </div>

      </div>
    </header>

    <main class="main">
      <section id="bossListPanel" class="card">
        <h4 style="font-size:12px;color:var(--muted);margin-bottom:6px;">Boss List</h4>
        <div id="bossList" class="scrollable"></div>
      </section>

      <aside class="right-column">
        <div id="nextBoss" class="card">
          <div class="boss-name">Next Boss</div>
          <div class="time-remaining" id="nextTime">‚Äî ‚Äî</div>
        </div>

        <section id="timersPanel" class="card">
          <h4 style="font-size:12px;color:var(--muted);margin-bottom:6px;">Active Timers</h4>
          <div id="timers" class="scrollable"></div>
        </section>
      </aside>
    </main>
  </div>

  <!-- Modal + Loading -->
  <div id="timeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:1000;">
    <div style="background:#0b1320;padding:16px;border-radius:10px;max-width:320px;width:92%;color:#dff7ff;text-align:center;">
      <h3 id="modalBossName" style="margin-bottom:8px;"></h3>
      <input type="datetime-local" id="killTimeInput" style="width:100%;margin-bottom:10px;background:transparent;border:1px solid var(--accent);color:#fff;padding:6px;border-radius:6px;">
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="cancelTimeBtn" class="kbtn">Cancel</button>
        <button id="saveTimeBtn" class="kbtn">Save</button>
      </div>
    </div>
  </div>
  <div id="loadingOverlay">
	<div class="loader-text">Loading...</div>
  </div>

<!-- Full JavaScript (integrated and adapted to layout) -->
<script type="module">
// --- Data + constants (BOSSES unchanged) ---
const BOSSES = [
  { id: 'Venatus', name: 'Venatus', respawn: 60*60*10 },
  { id: 'Viorent', name: 'Viorent', respawn: 60*60*10 },
  { id: 'Ego', name: 'Ego', respawn: 60*60*21 },
  { id: 'Clemantis', name: 'Clemantis', weeklyRespawns: [{ day:1, hour:12, minute:30 }, { day:4, hour:20, minute:0 }] },
  { id: 'Livera', name: 'Livera', respawn: 60*60*24 },
  { id: 'Araneo', name: 'Araneo', respawn: 60*60*24 },
  { id: 'Undomiel', name: 'Undomiel', respawn: 60*60*24 },
  { id: 'Saphirus', name: 'Saphirus', weeklyRespawns: [{ day:0, hour:18, minute:0 }, { day:2, hour:12, minute:30 }] },
  { id: 'Neutro', name: 'Neutro', weeklyRespawns: [{ day:2, hour:20, minute:0 }, { day:4, hour:12, minute:30 }] },
  { id: 'Lady Dalia', name: 'Lady Dalia', respawn: 60*60*18 },
  { id: 'General Aquleus', name: 'General Aquleus', respawn: 60*60*29 },
  { id: 'Thymele', name: 'Thymele', weeklyRespawns: [{ day:1, hour:20, minute:0 }, { day:3, hour:12, minute:30 }] },
  { id: 'Amentis', name: 'Amentis', respawn: 60*60*29 },
  { id: 'Baron Braudmore', name: 'Baron Braudmore', respawn: 60*60*32 },
  { id: 'Milavy', name: 'Milavy', weeklyRespawns: [{ day:6, hour:16, minute:0 }] },
  { id: 'Wannitas', name: 'Wannitas', respawn: 60*60*48 },
  { id: 'Metus', name: 'Metus', respawn: 60*60*48 },
  { id: 'Duplican', name: 'Duplican', respawn: 60*60*48 },
  { id: 'Shuliar', name: 'Shuliar', respawn: 60*60*35 },
  { id: 'Ringor', name: 'Ringor', weeklyRespawns: [{ day:6, hour:18, minute:0 }] },
  { id: 'Roderick', name: 'Roderick', weeklyRespawns: [{ day:5, hour:20, minute:0 }] },
  { id: 'Gareth', name: 'Gareth', respawn: 60*60*32 },
  { id: 'Titore', name: 'Titore', respawn: 60*60*37 },
  { id: 'Larba', name: 'Larba', respawn: 60*60*35 },
  { id: 'Catena', name: 'Catena', respawn: 60*60*35 },
  { id: 'Auraq', name: 'Auraq', weeklyRespawns: [{ day:5, hour:23, minute:0 }, { day:3, hour:22, minute:0 }] },
  { id: 'Secreta', name: 'Secreta', respawn: 60*60*62 },
  { id: 'Ordo', name: 'Ordo', respawn: 60*60*62 },
  { id: 'Asta', name: 'Asta', respawn: 60*60*62 },
  { id: 'Supore', name: 'Supore', respawn: 60*60*62 },
  { id: 'Chaiflock', name: 'Chaiflock', weeklyRespawns: [{ day:6, hour:23, minute:0 }] },
  { id: 'Benji', name: 'Benji', weeklyRespawns: [{ day:0, hour:22, minute:0 }] }
];

// --- DOM refs adapted to layout ---
const bossListEl = document.getElementById('bossList');
const timersEl = document.getElementById('timers');
const nextBossNameEl = document.querySelector('#nextBoss .boss-name');
const nextTimeEl = document.getElementById('nextTime');
const searchInput = document.getElementById('bossSearch');
const clearSearch = document.getElementById('clearSearch');
const searchWrapper = document.querySelector('.search-wrapper');
const modal = document.getElementById('timeModal');
const modalName = document.getElementById('modalBossName');
const killTimeInput = document.getElementById('killTimeInput');
const cancelTimeBtn = document.getElementById('cancelTimeBtn');
const saveTimeBtn = document.getElementById('saveTimeBtn');
const loadingOverlay = document.getElementById('loadingOverlay');
const settingsBtn = document.getElementById('settingsBtn');

// toggle "has-text" class when user types
searchInput.addEventListener('input', () => {
  if (searchInput.value.trim() !== '') {
    searchWrapper.classList.add('has-text');
  } else {
    searchWrapper.classList.remove('has-text');
  }
});

// clear search when X is clicked
clearSearch.addEventListener('click', () => {
  searchInput.value = '';
  searchWrapper.classList.remove('has-text');
  renderBossList(); // refresh boss list
});

let firebaseLoaded = false;


// storage + state
let timers = {};
let currentBossForTime = null;
let justLoaded = true;
const STORAGE_KEY = 'ln_timers_v1';

// helpers
function formatSec(s){
  if(s<=0) return 'Ready';
  const d=Math.floor(s/86400); s%=86400;
  const h=Math.floor(s/3600); s%=3600;
  const m=Math.floor(s/60);
  const sec=s%60;
  if(d>0) return `${d}d ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m`;
  if(h>0) return `${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m`;
  return `${String(m).padStart(2,'0')}m ${String(sec).padStart(2,'0')}s`;
}
function getNextWeeklyRespawn(respawns, fromTime=Date.now()){
  const now=new Date(fromTime);
  let soonest=null;
  for(const {day,hour,minute} of respawns){
    const t=new Date(now);
    t.setHours(hour,minute,0,0);
    // set to next occurrence of that weekday
    t.setDate(now.getDate() + ((day + 7 - now.getDay()) % 7));
    if(t <= now) t.setDate(t.getDate() + 7);
    if(!soonest || t < soonest) soonest = t;
  }
  return soonest ? soonest.getTime() : now.getTime();
}

// FIRESTORE imports & init
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyD9n0a6rQbt_M3J51pIILf-Ticjbttc3eg",
  authDomain: "lordnine-timer-9f21e.firebaseapp.com",
  projectId: "lordnine-timer-9f21e",
  storageBucket: "lordnine-timer-9f21e.firebasestorage.app",
  messagingSenderId: "644000692891",
  appId: "1:644000692891:web:224bca1478655a43c0243e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function loadTimersFromFirestore(){
  try{
    const docRef = doc(db, 'timers', 'global');
    const snap = await getDoc(docRef);
    if(snap.exists()){
      // expect structure { timers: {id: {endTime, startedAt, ...}}}
      timers = snap.data().timers || {};
      return true;
    }
    timers = {};
    return true;
  }catch(e){
    console.warn('load err', e);
    timers = {};
    return false;
  }
}
async function saveTimersToFirestore(){
  try{
    await setDoc(doc(db, 'timers', 'global'), { timers });
  }catch(e){
    console.warn('save err', e);
  }
}

async function saveTimers(){
  try{ await saveTimersToFirestore(); }catch(e){ console.warn('save to firestore', e); }
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(timers)); }catch(e){}
}

// core actions
function startTimer(bossId){
  const boss = BOSSES.find(b=>b.id===bossId);
  if(!boss) return;
  const now = Date.now();
  let endTime;
  if(boss.weeklyRespawns){
    endTime = getNextWeeklyRespawn(boss.weeklyRespawns);
    timers[bossId] = { endTime, startedAt: now, weekly: true, notifiedSoon:false };
  } else {
    endTime = now + boss.respawn*1000;
    timers[bossId] = { endTime, startedAt: now, notifiedSoon:false };
  }
  saveTimers();
  renderAll();
}
function clearTimer(bossId){
  delete timers[bossId];
  saveTimers();
  renderAll();
}
function resetAll(){
  if(!confirm('Reset all timers?')) return;
  const preserved = {};
  

  timers = preserved;
  saveTimers();
  renderAll();
}

// modal
function openTimeModal(bossId){
  const boss = BOSSES.find(b=>b.id===bossId);
  if(!boss) return;
  currentBossForTime = boss;
  modalName.textContent = boss.name;
  killTimeInput.value = '';
  modal.style.display = 'flex';
}
function closeTimeModal(){
  modal.style.display = 'none';
  currentBossForTime = null;
}
cancelTimeBtn.addEventListener('click', closeTimeModal);
saveTimeBtn.addEventListener('click', ()=>{
  const input = killTimeInput.value;
  if(!input || !currentBossForTime) return;
  const parsed = new Date(input);
  if(isNaN(parsed)) { alert('Invalid date'); return; }
  const killedAt = parsed.getTime();
  const boss = currentBossForTime;
  let endTime;
  if(boss.weeklyRespawns){
    endTime = getNextWeeklyRespawn(boss.weeklyRespawns, killedAt+1);
    while(endTime <= killedAt) endTime += 7*24*60*60*1000;
    timers[boss.id] = { endTime, startedAt: killedAt, weekly:true, notifiedSoon:false };
  } else {
    endTime = killedAt + boss.respawn*1000;
    timers[boss.id] = { endTime, startedAt: killedAt, notifiedSoon:false };
  }
  saveTimers();
  closeTimeModal();
  renderAll();
});

// render functions
function renderBossList(){
  bossListEl.innerHTML = '';
  const q = (searchInput.value || '').toLowerCase().trim();
  for(const b of BOSSES){
    const isWeekly = !!b.weeklyRespawns;
	const isActive = timers[b.id] && timers[b.id].endTime > Date.now();
    if(q && !b.name.toLowerCase().includes(q)) continue;
    const subText = isWeekly ? b.weeklyRespawns.map(r=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][r.day] + ' ' + String(r.hour).padStart(2,'0') + ':' + String(r.minute).padStart(2,'0')).join(', ') : (b.respawn/3600) + ' hr';
    const node = document.createElement('div');
		node.className = 'boss' + (isActive ? ' dead' : '');
		node.innerHTML = `
		  <div class="meta">
			<div class="name">${b.name}</div>
			<div class="sub">${
			  isWeekly
				? b.weeklyRespawns.map(r =>
					['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][r.day] + ' ' +
					String(r.hour).padStart(2,'0') + ':' + String(r.minute).padStart(2,'0')
				  ).join(', ')
				: (b.respawn / 3600) + ' hr'
			}</div>
		  </div>
		  <div class="actions">
			${
			  isWeekly
				? `<button class="kbtn" data-id="${b.id}" title="Mark dead">${isActive ? 'Killed' : 'Mark as Dead'}</button>`
				: `<button class="kbtn" data-id="${b.id}" title="Mark dead">${isActive ? 'Killed' : 'Mark as Dead'}</button>
				   <button class="kbtn" data-id="${b.id}" data-set="1">Set</button>`
			}
		  </div>`;

    bossListEl.appendChild(node);
  }

  // attach handlers
  bossListEl.querySelectorAll('.kbtn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id = e.currentTarget.dataset.id;
      if(e.currentTarget.dataset.set) return openTimeModal(id);
      startTimer(id);
    });
  });
}

function renderTimers(){
  timersEl.innerHTML = '';
  const entries = Object.entries(timers)
    .map(([id,info])=>({ id, info, boss: BOSSES.find(b=>b.id===id) }))
    .filter(x=>x.boss)
    .sort((a,b)=>a.info.endTime - b.info.endTime);

  if(entries.length === 0){
    timersEl.innerHTML = '<div class="small" style="color:var(--muted)">No active timers</div>';
    nextBossNameEl.textContent = 'Next Boss: ‚Äî';
    nextTimeEl.textContent = '‚Äî';
    return;
  }

  for(const e of entries){
    const remainingSec = Math.round((e.info.endTime - Date.now())/1000);
    const remaining = Math.max(0, remainingSec);
    const node = document.createElement('div');
    node.className = 'timer' + (remaining===0 ? ' ready' : '');
    node.innerHTML = `
      <div>
        <div style="font-weight:700">${e.boss.name}</div>
        <div class="small" style="color:var(--muted)">Spawn: ${new Date(e.info.endTime).toLocaleString()}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800">${formatSec(remaining)}</div>
        <div style="margin-top:6px"><button class="kbtn" data-id="${e.id}">Clear</button></div>
      </div>
    `;
    timersEl.appendChild(node);
  }

  // attach clear buttons
  timersEl.querySelectorAll('.kbtn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      clearTimer(e.currentTarget.dataset.id);
    });
  });
}

function computeNextBoss() {
  const upcoming = Object.entries(timers)
    .map(([id, info]) => ({
      id,
      endTime: info.endTime,
      boss: BOSSES.find(b => b.id === id)
    }))
    .filter(x => x.boss)
    .sort((a, b) => a.endTime - b.endTime);

  if (upcoming.length === 0) {
    nextBossNameEl.textContent = 'Next Boss: ‚Äî';
    nextTimeEl.textContent = '‚Äî';
    return;
  }

  const soon = upcoming[0];
  const now = Date.now();
  const remainingMs = Math.max(0, soon.endTime - now);
  const totalSeconds = remainingMs / 1000;

  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = Math.floor(totalSeconds % 60);
  const millis = Math.floor(remainingMs % 1000);

  nextBossNameEl.textContent = `${soon.boss.name}`;
  nextTimeEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes
    .toString()
    .padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${millis
    .toString()
    .padStart(3, '0')}`;
}

function renderAll() {
  // Always render boss list (static)
  renderBossList();

  // If Firestore not yet loaded, skip timers and next boss
  if (!firebaseLoaded) {
    timersEl.innerHTML = '';
    nextBossNameEl.querySelector('.boss-name').textContent = 'Next Boss: ‚Äî ‚Äî';
    nextTimeEl.textContent = '‚Äî ‚Äî';
    return;
  }

  // Once Firestore is loaded, render everything as normal
  renderTimers();
  computeNextBoss();
}

// tick: update every second
setInterval(()=>{
  if (!firebaseLoaded) return; // <-- skip until Firebase ready
  const now = Date.now();
  for (const id of Object.keys(timers)) {
    const info = timers[id];
    const boss = BOSSES.find(b=>b.id===id);
    if (!boss) continue;
    const remainingMs = info.endTime - now;
    if (justLoaded) continue;
    if (remainingMs <= 5*60*1000 && remainingMs > 0 && !info.notifiedSoon) {
      info.notifiedSoon = true;
    }
    if (info.endTime <= now) {
      if (boss.weeklyRespawns) {
        const nextTime = getNextWeeklyRespawn(boss.weeklyRespawns);
        timers[id] = { endTime: nextTime, startedAt: now, weekly:true, notifiedSoon:false };
      } else {
        const nextTime = now + (boss.respawn*1000) + (5*60*1000);
        timers[id] = { endTime: nextTime, startedAt: now, notifiedSoon:false };
      }
    }
  }
  renderTimers();
  computeNextBoss();
}, 10);


setTimeout(()=>justLoaded = false, 5000);

// UI wiring
searchInput.addEventListener('input', ()=> renderBossList());
const settingsMenu = document.getElementById('settingsMenu');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const resetBtn = document.getElementById('resetBtn');

// Toggle menu visibility
settingsBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  const isVisible = settingsMenu.style.display === 'flex';
  settingsMenu.style.display = isVisible ? 'none' : 'flex';
});

// Hide menu when clicking outside
document.addEventListener('click', () => {
  settingsMenu.style.display = 'none';
});

// Export JSON
exportBtn.addEventListener('click', () => {
  try {
    const blob = new Blob([JSON.stringify(timers, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'boss_timers_backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('‚úÖ Timers exported successfully.');
  } catch (e) {
    console.error(e);
    alert('‚ùå Failed to export timers.');
  }
});

// Import JSON
importBtn.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const text = await file.text();
    try {
      const imported = JSON.parse(text);
      if (confirm('Import this JSON data? It will overwrite existing timers.')) {
        timers = imported;
        await saveTimers();
        renderAll();
        alert('‚úÖ Timers imported successfully.');
      }
    } catch (e) {
      alert('‚ùå Invalid JSON file.');
    }
  };
  input.click();
});

// Reset All
resetBtn.addEventListener('click', () => {
  if (confirm('Are you sure you want to reset all timers?')) resetAll();
});



async function init() {
  // Step 1: Show loading overlay
  loadingOverlay.style.display = 'flex';

  // Wait until DOM is ready
  await new Promise(resolve => {
    if (document.readyState === 'complete' || document.readyState === 'interactive') resolve();
    else document.addEventListener('DOMContentLoaded', resolve, { once: true });
  });

  // Step 2: Do NOT render anything yet ‚Äî keep panels empty
  bossListEl.innerHTML = '';
  timersEl.innerHTML = '';
  nextBossNameEl.textContent = '';
  nextTimeEl.textContent = '';

  // Step 3: Load timers from Firestore
  let firestoreTimers = {};
  try {
    const docRef = doc(db, 'timers', 'global');
    const snap = await getDoc(docRef);
    if (snap.exists()) {
      firestoreTimers = snap.data().timers || {};
      console.log('Loaded timers from Firestore:', firestoreTimers);
    } else {
      console.log('No Firestore data found.');
    }
  } catch (e) {
    console.warn('Firestore load failed', e);
  }

  // Step 4: Merge with localStorage (optional; Firestore takes priority)
  let localTimers = {};
  try {
    localTimers = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  } catch (e) {
    console.warn('localStorage load error', e);
  }

  // Combine both (Firestore overrides local)
	timers = { ...localTimers, ...firestoreTimers };

	// --- Fix timers that finished while offline: advance them to the next valid spawn ---
	const now = Date.now();
	let timersChanged = false;

	for (const [id, info] of Object.entries(timers)) {
	  const boss = BOSSES.find(b => b.id === id);
	  if (!boss || !info || !info.endTime) continue;

	  // if timer already expired while we were offline, advance it
	  if (info.endTime <= now) {
		if (boss.weeklyRespawns) {
		  // set to the next weekly respawn after 'now'
		  const next = getNextWeeklyRespawn(boss.weeklyRespawns, now + 1);
		  timers[id] = { endTime: next, startedAt: now, weekly: true, notifiedSoon: false };
		  timersChanged = true;
		} else if (boss.respawn) {
		  // for fixed-interval respawns: calculate how many cycles passed and advance
		  const respMs = boss.respawn * 1000;
		  // number of full cycles passed since stored endTime (at least 1)
		  const cycles = Math.floor((now - info.endTime) / respMs) + 1;
		  const newEnd = info.endTime + cycles * respMs;
		  timers[id] = { endTime: newEnd, startedAt: now, notifiedSoon: false };
		  timersChanged = true;
		}
	  }
	}

	// If we changed anything (timers rolled forward), persist the updated state immediately
	if (timersChanged) {
	  // saveTimers will persist to Firestore + localStorage
	  await saveTimers();
	}


  // Step 5: Mark Firestore as loaded and render everything
	firebaseLoaded = true;
	renderAll();

	// Hide loading overlay immediately after data is rendered
	if (Object.keys(timers).length > 0 || firestoreTimers || localTimers) {
	  loadingOverlay.style.display = 'none';
	} else {
	  // fallback: small delay only if no data is loaded at all
	  setTimeout(() => {
		loadingOverlay.style.display = 'none';
	  }, 1000);
	}
	}

// Start initialization after the window loads
window.addEventListener('load', () => init());

</script>
</body>
</html>
